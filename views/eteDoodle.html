<!DOCTYPE html>
<html>
<head>
    <title>ETE Doodle</title>

    <link rel="stylesheet" href="http://code.jquery.com/ui/1.10.2/themes/smoothness/jquery-ui.css"/>
    <link rel="stylesheet" href="css/doodle.css"/>

    <script type="text/javascript" src="js/jquery-1.9.1.js"></script>
    <script type="text/javascript" src="js/jquery-ui-1.10.2.js"></script>

    <script type="text/javascript">

        window.URL = window.URL || window.webkitURL;
        navigator.getUserMedia = navigator.getUserMedia || navigator.webkitGetUserMedia ||
                navigator.mozGetUserMedia || navigator.msGetUserMedia;

        var uploadCanvasImage = function (canvas) {
            // Base64 encoded string of the image data
            var imageDataBase64 = canvas.toDataURL('image/png');

            // TODO: This call will be moved to when the user clicks "Save" after doodling on image
            $.post('/eteDoodle/saveSnapshot', {imageData: imageDataBase64}, function (data) {
                console.log("Image uploaded successfully.");
            });
        };

        var takeSnapshotFromVideo = function (video, stream, canvas, canvasContext) {
            canvasContext.drawImage(video, 0, 0, video.width, video.height);
            var imageData = canvasContext.getImageData(0, 0, video.width, video.height);

            // Stop the webcam
            video.pause();
            video.src = '';
            stream.stop();

            return imageData;
        };

        var startWebcamVideo = function (video, webStreamCallback) {

            var onVideoCaptureError =  function (error) {
                console.log("Video capture error: " + error.code);
                webStreamCallback(null);
            }

            if (navigator.getUserMedia) {
                navigator.getUserMedia({video: true}, function (stream) {
                    video.src = window.URL.createObjectURL(stream);
                    video.play();

                    if (webStreamCallback) {
                        webStreamCallback(stream);
                    }
                }, onVideoCaptureError);
            }
        };

        $(document).ready(function () {
            var $video = $('#videoCapture');
            var video = $video[0];
            var $canvas = $('#doodleCanvas')
            var canvas = $canvas[0];
            var canvasCtx = canvas.getContext('2d');
            var webCamStream = null;
            var origSnapshotImageData = null;
            var canvasOffset = $canvas.offset();
            var canvasOffsetLeft = canvasOffset.left;
            var canvasOffsetTop = canvasOffset.top;
            var currentColor = 'rgb(0, 0, 0, 0)';
            var mouseDown = false;


            canvasCtx.clearRect(0, 0, canvas.width, canvas.height);

            // TODO: We will take LeapMotion Input, use elementFromPoint and trigger click on the element
            // TODO: We could make things faster and directly do hit testing ourselves since its only several elements
            $(document).delegate('.paintColor', 'click', function (event) {
                currentColor = $(this).css('background-color');
                console.log("Clicked color = " + currentColor);
            });

            $('#resetImageButton').bind('click', function (event) {
                if (origSnapshotImageData) {
                    canvasCtx.putImageData(origSnapshotImageData, 0, 0);
                }
            });

            $('#saveImageButton').bind('click', function (event) {
                uploadCanvasImage(canvas);
            });

            $canvas.mouseenter(function (event) {
               console.log("Entered canvas");
            });

            $canvas.mouseleave(function (event) {
               console.log("Left canvas");
               // If mouseDown is still true, call stroke
               if (mouseDown) {
                   canvasCtx.stroke();
                   mouseDown = false;
               }
            });

            $canvas.mousedown(function (event) {
                console.log("Mouse down in canvas");
                mouseDown = true;
                canvasCtx.strokeStyle = currentColor;
                canvasCtx.beginPath();
                canvasCtx.moveTo((event.pageX - canvasOffsetLeft), (event.pageY - canvasOffsetTop));
            });

            $canvas.mouseup(function (event) {
                console.log("Mouse up in canvas");
                mouseDown = false;
                canvasCtx.stroke();
            });

            $canvas.mousemove(function (event) {
                if (mouseDown) {
                    console.log("Mouse down and moving in canvas");

                    // Draw a line to this point
                    var canvasX = (event.pageX - canvasOffsetLeft);
                    var canvasY = (event.pageY - canvasOffsetTop);
                    canvasCtx.lineTo(canvasX, canvasY);
                    canvasCtx.stroke();

                    // Now start a new path from this point
                    canvasCtx.beginPath();
                    canvasCtx.moveTo(canvasX, canvasY);
                }
            });

            $('#photoSnapshotDialog').dialog({
                resizable: false,
                modal: true,
                minWidth: 1050,
                minHeight: 794,
                buttons: {
                    "takeSnapshotButton": {
                        text: "Take photo",
                        id: "takeSnapshotButton",
                        click: function () {
                            origSnapshotImageData = takeSnapshotFromVideo(video, webCamStream, canvas, canvasCtx);
                            $(this).dialog('close');
                        }
                    }
                }
            });

            $('#takeSnapshotButton').attr('disabled', 'disabled');
            startWebcamVideo(video, function (stream) {
                webCamStream = stream;
                $('#takeSnapshotButton').removeAttr('disabled');
            });
        });
    </script>
</head>
<body>

<div id="doodleApp" style="width: 100%; height: 100%">
    <canvas id="doodleCanvas" width="1024" height="768" style="border: solid 2px;"></canvas>
    <div id="toolPane" class="toolPane">
        <ul class="paintColorList">
            <li class="paintColor backgroundRed"></li>
            <li class="paintColor backgroundGreen"></li>
            <li class="paintColor backgroundBlue"></li>
            <li class="paintColor backgroundYellow"></li>
        </ul>
        <ul class="actionButtonList" style="text-align: left;">
            <li><button id="resetImageButton" type="button" class="actionButton">START OVER</button></li>
            <li><button id="saveImageButton" type="button" class="actionButton">SAVE IT!!</button></li>
        </ul>
    </div>
</div>

<div id="photoSnapshotDialog" title="Smile!" style="width:1050px; height:794px;display:none;">
    <video id="videoCapture" width="1024" height="768" autoplay></video>
</div>

</body>
</html>