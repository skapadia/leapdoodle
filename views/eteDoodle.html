<!DOCTYPE html>
<html>
<head>
    <title>ETE Doodle</title>

    <link rel="stylesheet" href="http://code.jquery.com/ui/1.10.2/themes/smoothness/jquery-ui.css"/>
    <link rel="stylesheet" href="css/doodle.css"/>

    <script type="text/javascript" src="js/jquery-1.9.1.js"></script>
    <script type="text/javascript" src="js/jquery-ui-1.10.2.js"></script>

    <script type="text/javascript">

        window.URL = window.URL || window.webkitURL;
        navigator.getUserMedia = navigator.getUserMedia || navigator.webkitGetUserMedia ||
                navigator.mozGetUserMedia || navigator.msGetUserMedia;

        var takeSnapshotFromVideo = function (video, stream, canvas, canvasContext) {
            canvasContext.drawImage(video, 0, 0, video.width, video.height);

            video.pause();
            video.src = '';
            stream.stop();

            var imageData = canvas.toDataURL('image/png');

            // TODO: This call will be moved to when the user clicks "Save" after doodling on image
            $.post('/eteDoodle/saveSnapshot', {imageData: imageData});
        };


        $(document).ready(function () {
            var video = $('#videoCapture')[0];
            var canvas = $('#doodleCanvas')[0];
            var canvasCtx = $('#doodleCanvas')[0].getContext('2d');
            var webCamStream = null;

            canvasCtx.clearRect(0, 0, canvas.width, canvas.height);

            // TODO: We will take LeapMotion Input, use elementFromPoint and trigger click on the element
            // TODO: We could make things faster and directly do hit testing ourselves since its only several elements
            $(document).delegate('.paintColor', 'click', function (event) {
               console.log("Clicked color = " + $(this).css('background-color'));
            });

            $('#photoSnapshotDialog').dialog({
                resizable: false,
                modal: true,
                minWidth: 1050,
                minHeight: 794,
                buttons: {
                    "Take photo": function () {
                        takeSnapshotFromVideo(video, webCamStream, canvas, canvasCtx);
                        $(this).dialog('close');
                    }
                }
            });
            function onVideoCaptureError(error) {
                console.log("Video capture error: " + error.code);
            }

            if (navigator.getUserMedia) {
                navigator.getUserMedia({video: true}, function (stream) {
                    webCamStream = stream;
                    video.src = window.URL.createObjectURL(webCamStream);
                    video.play();
                }, onVideoCaptureError);
            }
        });
    </script>
</head>
<body>

<div id="doodleApp" style="width: 100%; height: 100%">
    <canvas id="doodleCanvas" width="1024" height="768" style="border: solid 2px;"></canvas>
    <div id="toolPane" class="toolPane">
        <ul class="paintColorList">
            <li class="paintColor backgroundRed"></li>
            <li class="paintColor backgroundGreen"></li>
            <li class="paintColor backgroundBlue"></li>
            <li class="paintColor backgroundYellow"></li>
        </ul>
    </div>
</div>

<div id="photoSnapshotDialog" title="Smile!" style="width:1050px; height:794px;display:none;">
    <video id="videoCapture" width="1024" height="768" autoplay></video>
</div>

</body>
</html>